<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Categories - Event Tracker</title>
    <link href="/css/output.css" rel="stylesheet">
    <script src="sidebar.js"></script>
</head>
<body class="bg-slate-100 min-h-screen">
    <!-- Sidebar Container - populated by sidebar.js -->
    <div id="sidebar-container"></div>

    <!-- Main Content -->
    <main id="mainContent" class="main-content lg:ml-64 min-h-screen">
        <!-- Header Container - populated by sidebar.js -->
        <div id="header-container"></div>

        <div class="p-4 lg:p-6">
            <!-- Create Category -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
                <h2 class="text-lg font-bold text-slate-800 mb-4">Create New Category</h2>
                <div class="flex flex-wrap gap-4">
                    <input type="text" id="categoryName" placeholder="Category name..." class="flex-1 min-w-48 px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-slate-400 text-slate-700">
                    <select id="categoryColor" class="px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-slate-400 text-slate-700">
                        <option value="blue">Blue</option>
                        <option value="purple">Purple</option>
                        <option value="pink">Pink</option>
                        <option value="green">Green</option>
                        <option value="yellow">Yellow</option>
                        <option value="red">Red</option>
                        <option value="indigo">Indigo</option>
                        <option value="orange">Orange</option>
                    </select>
                    <button onclick="createCategory()" class="px-6 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-800 font-semibold">Create</button>
                </div>
            </div>

            <!-- Categories Grid -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
                <h2 class="text-lg font-bold text-slate-800 mb-4">Your Categories</h2>
                <div id="categoriesList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="text-center py-8 text-slate-500">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-slate-600 mb-2"></div>
                        <p>Loading categories...</p>
                    </div>
                </div>
            </div>

            <!-- Assign Artists Section -->
            <div id="assignSection" class="bg-white rounded-xl shadow-sm border border-slate-200 p-6" style="display:none;">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-slate-800"><span id="sectionMode">Manage</span>: <span id="currentCategoryName"></span></h2>
                    <button onclick="closeAssignSection()" class="text-slate-500 hover:text-slate-700">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <div id="artistsList" class="space-y-2 max-h-96 overflow-y-auto"></div>
            </div>
        </div>
    </main>

    <script>
        const API_BASE_URL = 'http://localhost:5000/api/v1';
        let token = localStorage.getItem('token');

        if (!token) { window.location.href = 'auth.html'; }

        document.addEventListener('DOMContentLoaded', () => {
            initSidebar('Manage Categories');
            loadUser();
            loadCategories();
        });

        async function loadUser() {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/me`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await response.json();
                if (data.success) {
                    updateSidebarUser(data.user);
                }
            } catch (error) { console.error('Load user error:', error); }
        }

        async function loadCategories() {
            try {
                const response = await fetch(`${API_BASE_URL}/categories`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await response.json();
                if (data.success) displayCategories(data.categories);
                else document.getElementById('categoriesList').innerHTML = `<p class="text-center text-slate-500 py-8">No categories yet. Create your first one above!</p>`;
            } catch (error) { console.error('Load categories error:', error); }
        }

        async function createCategory() {
            const name = document.getElementById('categoryName').value.trim();
            const color = document.getElementById('categoryColor').value;
            if (!name) { alert('Please enter a category name'); return; }
            try {
                const response = await fetch(`${API_BASE_URL}/categories`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ name, color }) });
                const data = await response.json();
                if (data.success) { document.getElementById('categoryName').value = ''; loadCategories(); }
                else alert(data.message || 'Error creating category');
            } catch (error) { console.error('Create category error:', error); alert('Error creating category. Please try again.'); }
        }

        function displayCategories(categories) {
            const container = document.getElementById('categoriesList');
            if (categories.length === 0) { container.innerHTML = `<div class="col-span-2 text-center py-8 text-slate-500"><p>No categories yet. Create your first category above!</p></div>`; return; }

            const colorMap = {
                blue: { bg: 'bg-blue-50', border: 'border-blue-200', text: 'text-blue-900', subtext: 'text-blue-600', color: 'bg-blue-500', button: 'bg-blue-600 hover:bg-blue-700' },
                purple: { bg: 'bg-purple-50', border: 'border-purple-200', text: 'text-purple-900', subtext: 'text-purple-600', color: 'bg-purple-500', button: 'bg-purple-600 hover:bg-purple-700' },
                pink: { bg: 'bg-pink-50', border: 'border-pink-200', text: 'text-pink-900', subtext: 'text-pink-600', color: 'bg-pink-500', button: 'bg-pink-600 hover:bg-pink-700' },
                green: { bg: 'bg-green-50', border: 'border-green-200', text: 'text-green-900', subtext: 'text-green-600', color: 'bg-green-500', button: 'bg-green-600 hover:bg-green-700' },
                yellow: { bg: 'bg-yellow-50', border: 'border-yellow-200', text: 'text-yellow-900', subtext: 'text-yellow-600', color: 'bg-yellow-500', button: 'bg-yellow-600 hover:bg-yellow-700' },
                red: { bg: 'bg-red-50', border: 'border-red-200', text: 'text-red-900', subtext: 'text-red-600', color: 'bg-red-500', button: 'bg-red-600 hover:bg-red-700' },
                indigo: { bg: 'bg-indigo-50', border: 'border-indigo-200', text: 'text-indigo-900', subtext: 'text-indigo-600', color: 'bg-indigo-500', button: 'bg-indigo-600 hover:bg-indigo-700' },
                orange: { bg: 'bg-orange-50', border: 'border-orange-200', text: 'text-orange-900', subtext: 'text-orange-600', color: 'bg-orange-500', button: 'bg-orange-600 hover:bg-orange-700' }
            };

            container.innerHTML = categories.map(category => {
                const colors = colorMap[category.color] || colorMap.blue;
                return `
                    <div class="border rounded-xl p-4 ${colors.bg} ${colors.border}">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 ${colors.color} rounded-full"></div>
                                <div>
                                    <h3 class="font-bold ${colors.text}">${category.name}</h3>
                                    <p class="text-sm ${colors.subtext}">${category.artistCount || 0} artists</p>
                                </div>
                            </div>
                            <button onclick="deleteCategory('${category._id}')" class="text-rose-600 hover:text-rose-800">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="viewCategoryArtists('${category._id}', '${category.name}')" class="flex-1 px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700 text-sm">View</button>
                            <button onclick="manageCategoryArtists('${category._id}', '${category.name}')" class="flex-1 px-4 py-2 ${colors.button} text-white rounded-lg text-sm">Manage</button>
                        </div>
                    </div>`;
            }).join('');
        }

        async function deleteCategory(categoryId) {
            if (!confirm('Are you sure you want to delete this category? All artist assignments will be removed.')) return;
            try {
                const response = await fetch(`${API_BASE_URL}/categories/${categoryId}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                const data = await response.json();
                if (data.success) loadCategories();
                else alert(data.message || 'Error deleting category');
            } catch (error) { console.error('Delete category error:', error); alert('Error deleting category. Please try again.'); }
        }

        async function viewCategoryArtists(categoryId, categoryName) {
            document.getElementById('currentCategoryName').textContent = categoryName;
            document.getElementById('sectionMode').textContent = 'View';
            document.getElementById('assignSection').style.display = 'block';
            try {
                const response = await fetch(`${API_BASE_URL}/categories/${categoryId}/artists`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await response.json();
                if (data.success && data.artists) {
                    const sortedArtists = (data.artists || []).sort((a, b) => a.name.localeCompare(b.name));
                    const artistsHTML = sortedArtists.length > 0 ? sortedArtists.map(artist => `
                        <div class="flex items-center gap-3 p-3 border border-slate-200 rounded-lg bg-slate-50">
                            ${artist.images?.large ? `<img src="${artist.images.large}" alt="${artist.name}" class="w-12 h-12 rounded-lg object-cover">` : `<div class="w-12 h-12 rounded-lg bg-slate-200 flex items-center justify-center"><svg class="text-slate-400" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg></div>`}
                            <span class="flex-1 font-semibold text-slate-800">${artist.name}</span>
                            <span class="text-sm text-slate-600">${artist.genre?.join(', ') || 'Unknown Genre'}</span>
                        </div>`).join('') : '<p class="text-center text-slate-500 py-8">No artists in this category yet.</p>';
                    document.getElementById('artistsList').innerHTML = artistsHTML;
                } else document.getElementById('artistsList').innerHTML = '<p class="text-center text-slate-500 py-8">No artists in this category yet.</p>';
            } catch (error) { console.error('Load artists error:', error); document.getElementById('artistsList').innerHTML = '<p class="text-center text-rose-600 py-8">Error loading artists.</p>'; }
        }

        async function manageCategoryArtists(categoryId, categoryName) {
            document.getElementById('currentCategoryName').textContent = categoryName;
            document.getElementById('sectionMode').textContent = 'Manage';
            document.getElementById('assignSection').style.display = 'block';
            try {
                const [favResponse, assignedResponse] = await Promise.all([
                    fetch(`${API_BASE_URL}/users/favorites`, { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch(`${API_BASE_URL}/categories/${categoryId}/artists`, { headers: { 'Authorization': `Bearer ${token}` } })
                ]);
                const favData = await favResponse.json();
                const assignedData = await assignedResponse.json();
                const assignedArtistIds = new Set(assignedData.artists?.map(a => a._id) || []);
                const artistsHTML = favData.artists?.map(artist => `
                    <label class="flex items-center gap-3 p-3 border border-slate-200 rounded-lg hover:bg-slate-50 cursor-pointer">
                        <input type="checkbox" ${assignedArtistIds.has(artist._id) ? 'checked' : ''} onchange="toggleArtistCategory('${categoryId}', '${artist._id}', this.checked)" class="w-4 h-4 text-slate-600">
                        <span class="flex-1 text-slate-800">${artist.name}</span>
                    </label>`).join('') || '<p class="text-slate-500">No favorite artists yet.</p>';
                document.getElementById('artistsList').innerHTML = artistsHTML;
            } catch (error) { console.error('Load artists error:', error); }
        }

        async function toggleArtistCategory(categoryId, artistId, isChecked) {
            try {
                const method = isChecked ? 'POST' : 'DELETE';
                const response = await fetch(`${API_BASE_URL}/categories/${categoryId}/artists/${artistId}`, { method, headers: { 'Authorization': `Bearer ${token}` } });
                const data = await response.json();
                if (!data.success) alert(data.message || 'Error updating assignment');
                loadCategories();
            } catch (error) { console.error('Toggle assignment error:', error); }
        }

        function closeAssignSection() { document.getElementById('assignSection').style.display = 'none'; }
    </script>
</body>
</html>