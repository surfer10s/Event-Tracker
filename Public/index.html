<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Tracker</title>
    <link href="/css/output.css" rel="stylesheet">
    <script src="sidebar.js"></script>
    <style>
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .scroll-container {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .scroll-container::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">
    <!-- Sidebar Container - populated by sidebar.js -->
    <div id="sidebar-container"></div>

    <!-- Main Content -->
    <main id="mainContent" class="main-content lg:ml-64 min-h-screen">
        <!-- Top Header with Search -->
        <header class="bg-white border-b border-slate-200 sticky top-0 z-30">
            <div class="px-4 lg:px-6 py-4 flex items-center justify-between">
                <!-- Hamburger Menu - visible when sidebar is collapsed -->
                <button id="headerHamburger" onclick="toggleSidebar()" class="p-2 hover:bg-slate-100 rounded-lg mr-4 hidden">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-slate-600">
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                
                <div class="flex-1 max-w-xl relative">
                    <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <input
                        type="text"
                        id="searchInput"
                        placeholder="Search artists, events, venues..."
                        class="w-full pl-10 pr-4 py-2 bg-slate-100 border-0 rounded-lg focus:ring-2 focus:ring-slate-400 focus:bg-white text-slate-700"
                    />
                    <!-- Artist Suggestions Dropdown -->
                    <div id="artistSuggestions" class="absolute w-full bg-white border border-slate-200 rounded-lg shadow-lg mt-1 max-h-64 overflow-y-auto z-40" style="display: none;">
                    </div>
                </div>
                
                <div class="flex items-center gap-4 ml-4">
                    <button class="p-2 text-slate-500 hover:text-slate-700 hover:bg-slate-100 rounded-lg relative">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                    </button>
                    
                    <!-- User Menu -->
                    <div class="relative" id="userMenuContainer">
                        <button id="userMenuButton" onclick="toggleUserMenu()" class="flex items-center gap-2 px-3 py-2 hover:bg-slate-100 rounded-lg">
                            <div class="w-8 h-8 bg-slate-600 rounded-full flex items-center justify-center text-white font-semibold text-sm" id="headerUserInitial">?</div>
                            <span class="text-slate-700 font-medium hidden md:inline" id="headerUserName">Account</span>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-slate-400">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </button>
                        
                        <div id="userDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-2 border border-slate-200">
                            <a href="account-details.html" class="block px-4 py-2 text-slate-700 hover:bg-slate-100 flex items-center gap-2">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="12" cy="7" r="4"></circle>
                                </svg>
                                Account Details
                            </a>
                            <a href="concert-history.html" class="block px-4 py-2 text-slate-700 hover:bg-slate-100 flex items-center gap-2">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 18V5l12-2v13"></path>
                                    <circle cx="6" cy="18" r="3"></circle>
                                    <circle cx="18" cy="16" r="3"></circle>
                                </svg>
                                Concert History
                            </a>
                            <hr class="my-1">
                            <button onclick="logout()" class="block w-full text-left px-4 py-2 text-rose-600 hover:bg-rose-50 flex items-center gap-2">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                    <polyline points="16 17 21 12 16 7"></polyline>
                                    <line x1="21" y1="12" x2="9" y2="12"></line>
                                </svg>
                                Logout
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div class="p-4 lg:p-6">
            <!-- Welcome + Stats Section -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <!-- Welcome Card -->
                <div class="lg:col-span-2 bg-gradient-to-r from-slate-700 to-slate-600 rounded-2xl p-6 text-white">
                    <h1 class="text-2xl font-bold mb-2">Welcome back<span id="welcomeName"></span>! ðŸ‘‹</h1>
                    <p class="text-slate-300 mb-6">Discover concerts, track your favorite artists, and never miss a show.</p>
                    
                    <div class="grid grid-cols-3 gap-4">
                        <a href="favorites.html" class="bg-white/10 rounded-xl p-4 backdrop-blur hover:bg-white/20 transition-colors">
                            <div class="text-3xl font-bold" id="statFavorites">0</div>
                            <div class="text-sm text-slate-300">Favorite Artists</div>
                        </a>
                        <a href="concert-history.html" class="bg-white/10 rounded-xl p-4 backdrop-blur hover:bg-white/20 transition-colors">
                            <div class="text-3xl font-bold" id="statConcerts">0</div>
                            <div class="text-sm text-slate-300">Concerts Attended</div>
                        </a>
                        <a href="favorites-activity.html" class="bg-white/10 rounded-xl p-4 backdrop-blur hover:bg-white/20 transition-colors">
                            <div class="text-3xl font-bold" id="statEvents">0</div>
                            <div class="text-sm text-slate-300">Upcoming Shows</div>
                        </a>
                    </div>
                </div>
                
                <!-- Quick Actions Card -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <h3 class="font-bold text-lg text-slate-800 mb-4">Quick Actions</h3>
                    <div class="space-y-3">
                        <a href="favorites.html" class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition-colors">
                            <div class="w-10 h-10 bg-rose-100 rounded-lg flex items-center justify-center">
                                <svg class="text-rose-500" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="font-semibold text-slate-800 text-sm">View Favorites</p>
                                <p class="text-xs text-slate-500">See your saved artists</p>
                            </div>
                        </a>
                        <a href="concert-history.html" class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition-colors">
                            <div class="w-10 h-10 bg-emerald-100 rounded-lg flex items-center justify-center">
                                <svg class="text-emerald-500" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                    <path d="m9 16 2 2 4-4"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="font-semibold text-slate-800 text-sm">Log a Concert</p>
                                <p class="text-xs text-slate-500">Add to your history</p>
                            </div>
                        </a>
                        <a href="discover-concerts.html" class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition-colors">
                            <div class="w-10 h-10 bg-violet-100 rounded-lg flex items-center justify-center">
                                <svg class="text-violet-500" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <path d="m21 21-4.35-4.35"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="font-semibold text-slate-800 text-sm">Discover Artists</p>
                                <p class="text-xs text-slate-500">Find similar artists</p>
                            </div>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Upcoming for Favorites Section -->
            <div id="favoritesUpcoming" class="mb-8 hidden">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-slate-800">Upcoming for Your Favorites</h2>
                    <a href="favorites.html" class="text-slate-600 hover:text-slate-800 font-semibold text-sm">View All â†’</a>
                </div>
                
                <div id="favoritesUpcomingList" class="flex gap-4 overflow-x-auto scroll-container pb-2">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <!-- Search Section (collapsible) -->
            <div id="searchSection" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-slate-800">Search Events</h2>
                    <button onclick="toggleSearchSection()" class="text-slate-500 hover:text-slate-700">
                        <svg id="searchToggleIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="18 15 12 9 6 15"></polyline>
                        </svg>
                    </button>
                </div>
                
                <div id="searchContent">
                    <!-- Search Mode Selection -->
                    <div class="flex items-center gap-6 mb-4">
                        <div class="flex items-center gap-2">
                            <input type="radio" id="searchDatabase" name="searchMode" value="database" class="text-slate-600">
                            <label for="searchDatabase" class="text-sm font-medium text-slate-700">Search Database</label>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="radio" id="searchLive" name="searchMode" value="live" checked class="text-slate-600">
                            <label for="searchLive" class="text-sm font-medium text-slate-700">Search Live (Ticketmaster)</label>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                        <input
                            type="text"
                            id="cityFilter"
                            placeholder="City"
                            class="px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-slate-400 text-slate-700"
                        />
                        <select id="stateFilter" class="px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-slate-400 text-slate-700">
                            <option value="">All States</option>
                            <option value="AL">Alabama</option>
                            <option value="AK">Alaska</option>
                            <option value="AZ">Arizona</option>
                            <option value="AR">Arkansas</option>
                            <option value="CA">California</option>
                            <option value="CO">Colorado</option>
                            <option value="CT">Connecticut</option>
                            <option value="FL">Florida</option>
                            <option value="GA">Georgia</option>
                            <option value="IL">Illinois</option>
                            <option value="IN">Indiana</option>
                            <option value="LA">Louisiana</option>
                            <option value="MD">Maryland</option>
                            <option value="MA">Massachusetts</option>
                            <option value="MI">Michigan</option>
                            <option value="MN">Minnesota</option>
                            <option value="MO">Missouri</option>
                            <option value="NV">Nevada</option>
                            <option value="NJ">New Jersey</option>
                            <option value="NY">New York</option>
                            <option value="NC">North Carolina</option>
                            <option value="OH">Ohio</option>
                            <option value="OR">Oregon</option>
                            <option value="PA">Pennsylvania</option>
                            <option value="TN">Tennessee</option>
                            <option value="TX">Texas</option>
                            <option value="WA">Washington</option>
                        </select>
                        <input
                            type="date"
                            id="startDateFilter"
                            class="px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-slate-400 text-slate-700"
                        />
                        <button
                            onclick="handleSearch()"
                            class="bg-slate-700 text-white px-6 py-2 rounded-lg hover:bg-slate-800 transition-colors font-semibold"
                        >
                            Search
                        </button>
                    </div>
                </div>
            </div>

            <!-- Events Section -->
            <div class="mb-4">
                <h2 class="text-lg font-bold text-slate-800 mb-4">Browse Events</h2>
            </div>

            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="flex justify-center py-12" style="display: none;">
                <svg class="animate-spin h-12 w-12 text-slate-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>

            <!-- Events Grid -->
            <div id="eventsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            </div>

            <!-- No Results -->
            <div id="noResults" class="text-center py-12" style="display: none;">
                <svg class="mx-auto text-slate-300 mb-4" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18V5l12-2v13"></path>
                    <circle cx="6" cy="18" r="3"></circle>
                    <circle cx="18" cy="16" r="3"></circle>
                </svg>
                <h3 class="text-xl font-semibold text-slate-700 mb-2">No events found</h3>
                <p class="text-slate-500">Try adjusting your search or filters</p>
            </div>

            <!-- Pagination -->
            <div id="pagination" class="flex justify-center gap-2" style="display: none;"></div>
        </div>
    </main>

    <script>
        const API_BASE_URL = 'http://localhost:5000/api/v1';
        let currentPage = 1;
        let currentFilters = {};
        let searchMode = 'live';
        let selectedArtistId = null;
        let artistSearchTimeout = null;
        let cachedArtistResults = {};
        let token = localStorage.getItem('token');
        let currentUser = null;

        function showSearchSection() {
            document.getElementById('searchSection').scrollIntoView({ behavior: 'smooth' });
            if (window.innerWidth < 1024) toggleSidebar();
        }

        function toggleSearchSection() {
            const content = document.getElementById('searchContent');
            const icon = document.getElementById('searchToggleIcon');
            content.classList.toggle('hidden');
            icon.style.transform = content.classList.contains('hidden') ? 'rotate(180deg)' : '';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize sidebar from sidebar.js
            initSidebar('Home');
            
            loadUser();
            fetchDatabaseEvents(1);
            loadUserStats();
            
            // Add enter key support for search
            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleSearch();
            });

            // Search mode change handler
            document.querySelectorAll('input[name="searchMode"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    searchMode = e.target.value;
                });
            });

            // Artist autocomplete for search
            document.getElementById('searchInput').addEventListener('input', (e) => {
                const query = e.target.value.trim();
                
                if (query.length >= 2) {
                    clearTimeout(artistSearchTimeout);
                    artistSearchTimeout = setTimeout(() => fetchArtistSuggestions(query), 300);
                } else {
                    document.getElementById('artistSuggestions').style.display = 'none';
                }
            });

            // Close artist suggestions when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#artistSuggestions') && !e.target.closest('#searchInput')) {
                    document.getElementById('artistSuggestions').style.display = 'none';
                }
            });
        });

        async function loadUser() {
            if (!token) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    const name = data.user.firstName || data.user.username;
                    
                    // Update welcome message
                    document.getElementById('welcomeName').textContent = `, ${name}`;
                    
                    // Update header user info
                    const initial = name.charAt(0).toUpperCase();
                    document.getElementById('headerUserInitial').textContent = initial;
                    document.getElementById('headerUserName').textContent = name;
                    
                    // Update sidebar user info using sidebar.js function
                    updateSidebarUser(data.user);
                    
                    // Load favorites upcoming
                    loadFavoritesUpcoming();
                } else {
                    token = null;
                    localStorage.removeItem('token');
                }
            } catch (error) {
                console.error('Load user error:', error);
            }
        }

        async function loadUserStats() {
            if (!token) return;
            
            try {
                // Get favorites count - uses /users/favorites which returns { artists: [], count: n }
                const favResponse = await fetch(`${API_BASE_URL}/users/favorites`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const favData = await favResponse.json();
                if (favData.success) {
                    const count = favData.count || (favData.artists ? favData.artists.length : 0);
                    document.getElementById('statFavorites').textContent = count;
                    
                    // Get upcoming events count for all favorite artists
                    const artists = favData.artists || [];
                    let totalUpcomingEvents = 0;
                    
                    for (const artist of artists) {
                        try {
                            const eventResponse = await fetch(`${API_BASE_URL}/events/artist/${artist._id}`);
                            const eventData = await eventResponse.json();
                            if (eventData.success && eventData.events) {
                                totalUpcomingEvents += eventData.events.length;
                            }
                        } catch (err) {
                            console.error('Error fetching events for artist:', artist.name);
                        }
                    }
                    
                    document.getElementById('statEvents').textContent = totalUpcomingEvents;
                }
                
                // Get concert history count
                const concertResponse = await fetch(`${API_BASE_URL}/users/concert-history`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const concertData = await concertResponse.json();
                if (concertData.success) {
                    const count = concertData.count || (concertData.concerts ? concertData.concerts.length : 0);
                    document.getElementById('statConcerts').textContent = count;
                }
            } catch (error) {
                console.error('Load user stats error:', error);
            }
        }

        async function loadFavoritesUpcoming() {
            if (!token) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/users/favorites`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data.success && data.artists && data.artists.length > 0) {
                    const upcomingEvents = [];
                    
                    // Fetch upcoming events for each favorite artist
                    for (const artist of data.artists.slice(0, 5)) {
                        try {
                            const eventResponse = await fetch(`${API_BASE_URL}/events/artist/${artist._id}`);
                            const eventData = await eventResponse.json();
                            
                            if (eventData.success && eventData.events) {
                                eventData.events.slice(0, 2).forEach(event => {
                                    upcomingEvents.push({
                                        ...event,
                                        artistName: artist.name,
                                        artistImage: artist.images?.medium || artist.images?.small
                                    });
                                });
                            }
                        } catch (err) {
                            console.error('Error loading events for', artist.name);
                        }
                    }
                    
                    if (upcomingEvents.length > 0) {
                        document.getElementById('favoritesUpcoming').classList.remove('hidden');
                        displayFavoritesUpcoming(upcomingEvents);
                    }
                }
            } catch (error) {
                console.error('Load favorites upcoming error:', error);
            }
        }

        function displayFavoritesUpcoming(events) {
            const container = document.getElementById('favoritesUpcomingList');
            container.innerHTML = events.slice(0, 10).map(event => {
                const venue = event.venue || {};
                return `
                    <div class="flex-shrink-0 w-72 bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden hover:shadow-md transition-shadow">
                        <div class="p-4">
                            <div class="flex items-center gap-3 mb-3">
                                ${event.artistImage ? 
                                    `<img src="${event.artistImage}" class="w-12 h-12 rounded-full object-cover">` :
                                    `<div class="w-12 h-12 bg-slate-200 rounded-full flex items-center justify-center">
                                        <svg class="text-slate-400" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M9 18V5l12-2v13"></path>
                                            <circle cx="6" cy="18" r="3"></circle>
                                            <circle cx="18" cy="16" r="3"></circle>
                                        </svg>
                                    </div>`
                                }
                                <div>
                                    <p class="font-semibold text-slate-800">${event.artistName}</p>
                                    <p class="text-xs text-slate-500">${formatDate(event.date)}</p>
                                </div>
                            </div>
                            <p class="text-sm text-slate-600 mb-1">${venue.name || 'Venue TBA'}</p>
                            <p class="text-xs text-slate-400">${venue.city || ''}${venue.state ? ', ' + venue.state : ''}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function fetchArtistSuggestions(query) {
            if (cachedArtistResults[query]) {
                displayArtistSuggestions(cachedArtistResults[query]);
                return;
            }

            try {
                // Search both database and Ticketmaster in parallel
                const [dbResponse, tmResponse] = await Promise.all([
                    fetch(`${API_BASE_URL}/artists/search?q=${encodeURIComponent(query)}&limit=10`).catch(() => null),
                    fetch(`${API_BASE_URL}/ticketmaster/artists?keyword=${encodeURIComponent(query)}`).catch(() => null)
                ]);
                
                const dbData = dbResponse ? await dbResponse.json().catch(() => ({})) : {};
                const tmData = tmResponse ? await tmResponse.json().catch(() => ({})) : {};
                
                // Normalize database results
                const dbArtists = (dbData.success && dbData.artists) ? dbData.artists.map(a => ({
                    ...a,
                    _id: a._id,
                    name: a.name,
                    genre: a.genre?.[0] || a.genres?.[0],
                    images: a.images || {},
                    source: 'database'
                })) : [];
                
                // Normalize Ticketmaster results
                const tmArtists = (tmData.success && tmData.artists) ? tmData.artists.map(a => ({
                    ...a,
                    externalId: a.externalId,
                    name: a.name,
                    genre: a.genre,
                    images: a.images ? { small: a.images.find(img => img.width < 500)?.url, large: a.images.find(img => img.width >= 500)?.url } : {},
                    source: 'ticketmaster'
                })) : [];
                
                // Merge and dedupe - prioritize database results (they have MongoDB IDs)
                const seenNames = new Set();
                const mergedArtists = [];
                
                // Add database artists first (higher priority)
                for (const artist of dbArtists) {
                    const nameLower = artist.name.toLowerCase();
                    if (!seenNames.has(nameLower)) {
                        seenNames.add(nameLower);
                        mergedArtists.push(artist);
                    }
                }
                
                // Add Ticketmaster artists that aren't already in results
                for (const artist of tmArtists) {
                    const nameLower = artist.name.toLowerCase();
                    if (!seenNames.has(nameLower)) {
                        seenNames.add(nameLower);
                        mergedArtists.push(artist);
                    }
                }
                
                // Limit to 10 results
                const finalResults = mergedArtists.slice(0, 10);
                
                cachedArtistResults[query] = finalResults;
                displayArtistSuggestions(finalResults);
            } catch (error) {
                console.error('Artist search error:', error);
            }
        }

        function displayArtistSuggestions(artists) {
            const container = document.getElementById('artistSuggestions');
            
            if (!artists || artists.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.innerHTML = artists.map(artist => {
                const artistId = artist._id || artist.id || artist.externalId || artist.externalIds?.ticketmaster;
                const artistImage = artist.images?.small || artist.images?.large || (Array.isArray(artist.images) ? artist.images.find(img => img.width < 500)?.url : null);
                const genres = artist.genres || (artist.genre ? [artist.genre] : []);
                const isFromDatabase = artist.source === 'database' || artist._id;
                
                return `
                <div class="px-4 py-3 hover:bg-slate-50 cursor-pointer flex items-center gap-3 border-b last:border-b-0" onclick="selectArtist('${artistId}', '${artist.name.replace(/'/g, "\\'")}')">
                    ${artistImage ? 
                        `<img src="${artistImage}" class="w-10 h-10 rounded-full object-cover">` :
                        `<div class="w-10 h-10 bg-slate-200 rounded-full flex items-center justify-center">
                            <svg class="text-slate-400" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 18V5l12-2v13"></path>
                                <circle cx="6" cy="18" r="3"></circle>
                                <circle cx="18" cy="16" r="3"></circle>
                            </svg>
                        </div>`
                    }
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            <p class="font-medium text-slate-800">${artist.name}</p>
                            ${isFromDatabase ? 
                                `<span class="text-xs bg-emerald-100 text-emerald-700 px-1.5 py-0.5 rounded">Tracked</span>` : 
                                `<span class="text-xs bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded">Live</span>`
                            }
                        </div>
                        <p class="text-xs text-slate-500">${genres.slice(0, 2).join(', ') || 'Artist'}</p>
                    </div>
                </div>
            `}).join('');
            
            container.style.display = 'block';
        }

        function selectArtist(artistId, artistName) {
            document.getElementById('searchInput').value = artistName;
            document.getElementById('artistSuggestions').style.display = 'none';
            selectedArtistId = artistId;
            
            // Redirect to artist profile page
            // If artistId looks like a Ticketmaster ID (starts with K), use ticketmasterId param
            // If it's a MongoDB ObjectId (24 hex chars), use id param
            // If undefined/null, just use name
            if (!artistId || artistId === 'undefined' || artistId === 'null') {
                window.location.href = `artist-profile.html?name=${encodeURIComponent(artistName)}`;
            } else if (/^[0-9a-fA-F]{24}$/.test(artistId)) {
                window.location.href = `artist-profile.html?id=${artistId}&name=${encodeURIComponent(artistName)}`;
            } else {
                window.location.href = `artist-profile.html?ticketmasterId=${artistId}&name=${encodeURIComponent(artistName)}`;
            }
        }

        async function handleSearch() {
            const searchQuery = document.getElementById('searchInput').value.trim();
            const city = document.getElementById('cityFilter').value.trim();
            const state = document.getElementById('stateFilter').value;
            const startDate = document.getElementById('startDateFilter').value;

            currentFilters = { query: searchQuery, city, state, startDate };

            if (searchMode === 'database') {
                fetchDatabaseEvents(1);
            } else {
                fetchLiveEvents();
            }
        }

        async function fetchDatabaseEvents(page = 1) {
            showLoading();
            currentPage = page;

            try {
                let url = `${API_BASE_URL}/events?page=${page}&limit=20`;
                
                if (currentFilters.city) url += `&city=${encodeURIComponent(currentFilters.city)}`;
                if (currentFilters.state) url += `&state=${encodeURIComponent(currentFilters.state)}`;
                if (currentFilters.startDate) url += `&startDate=${currentFilters.startDate}`;

                const response = await fetch(url);
                const data = await response.json();

                hideLoading();
                
                if (data.success && data.events && data.events.length > 0) {
                    displayEvents(data.events);
                    displayPagination(data.currentPage, data.totalPages, data.total);
                } else {
                    document.getElementById('eventsGrid').style.display = 'none';
                    document.getElementById('noResults').style.display = 'block';
                }
            } catch (error) {
                showError('Failed to fetch events');
            }
        }

        async function fetchLiveEvents() {
            showLoading();

            try {
                let url = `${API_BASE_URL}/events/search?`;
                const params = [];

                if (currentFilters.query) params.push(`keyword=${encodeURIComponent(currentFilters.query)}`);
                if (currentFilters.city) params.push(`city=${encodeURIComponent(currentFilters.city)}`);
                if (currentFilters.state) params.push(`stateCode=${encodeURIComponent(currentFilters.state)}`);
                if (currentFilters.startDate) params.push(`startDateTime=${currentFilters.startDate}T00:00:00Z`);

                url += params.join('&');

                const response = await fetch(url);
                const data = await response.json();

                hideLoading();

                if (data.success && data.events && data.events.length > 0) {
                    displayEvents(data.events, true);
                    document.getElementById('pagination').style.display = 'none';
                } else {
                    document.getElementById('eventsGrid').style.display = 'none';
                    document.getElementById('noResults').style.display = 'block';
                }
            } catch (error) {
                showError('Failed to search events');
            }
        }

        function displayEvents(events, isLive = false) {
            document.getElementById('eventsGrid').style.display = 'grid';
            document.getElementById('noResults').style.display = 'none';
            
            const grid = document.getElementById('eventsGrid');
            
            grid.innerHTML = events.map(event => {
                const images = event.images || {};
                const artistName = event.artist?.name || event.artistName || 'Various Artists';
                const artistId = event.artist?._id || event.artist?.externalIds?.ticketmaster || '';
                const sourceBadge = isLive ? 
                    '<span class="bg-emerald-100 text-emerald-700 text-xs px-2 py-1 rounded-full">Live</span>' :
                    '<span class="bg-slate-100 text-slate-600 text-xs px-2 py-1 rounded-full">Saved</span>';
                const venue = event.venue || {};
                const ticketInfo = event.ticketInfo || {};
                const eventId = event._id || event.externalIds?.ticketmaster;
                const affiliateUrl = event.affiliateLinks?.ticketmaster?.url || null;
                
                const artistTourLink = event.artist?._id 
                    ? `artist-profile.html?id=${event.artist._id}&name=${encodeURIComponent(artistName)}`
                    : `artist-profile.html?ticketmasterId=${artistId}&name=${encodeURIComponent(artistName)}`;
                
                return `
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden hover:shadow-md transition-shadow">
                    ${images.large ? `
                        <img src="${images.large}" alt="${event.name}" class="w-full h-48 object-cover">
                    ` : `
                        <div class="w-full h-48 bg-gradient-to-br from-slate-500 to-slate-600 flex items-center justify-center">
                            <svg class="text-white opacity-50" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 18V5l12-2v13"></path>
                                <circle cx="6" cy="18" r="3"></circle>
                                <circle cx="18" cy="16" r="3"></circle>
                            </svg>
                        </div>
                    `}
                    
                    <div class="p-4">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-lg line-clamp-2 flex-1 text-slate-800">${event.name}</h3>
                            ${sourceBadge}
                        </div>
                        
                        <a href="${artistTourLink}" class="text-sm text-slate-600 font-semibold hover:text-slate-800 mb-2 inline-block">
                            ${artistName} â†’
                        </a>
                        
                        <div class="space-y-1 text-sm text-slate-500 mb-3">
                            <div class="flex items-center gap-2">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                                ${formatDate(event.date)}
                            </div>
                            <div class="flex items-center gap-2">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                    <circle cx="12" cy="10" r="3"></circle>
                                </svg>
                                ${venue.city}, ${venue.state || venue.country}
                            </div>
                            <div class="flex items-center gap-2">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                </svg>
                                ${venue.name}
                            </div>
                        </div>
                        
                        ${ticketInfo.minPrice ? `
                            <p class="text-sm font-semibold text-slate-700 mb-3">
                                From $${ticketInfo.minPrice}
                            </p>
                        ` : ''}
                        
                        ${affiliateUrl ? `
                            <button onclick="trackAndRedirect('${eventId}', '${affiliateUrl}')" class="w-full bg-slate-700 text-white py-2 rounded-lg hover:bg-slate-800 font-semibold">
                                Get Tickets
                            </button>
                        ` : `
                            <div class="w-full bg-slate-100 text-slate-400 py-2 rounded-lg text-center text-sm">
                                Tickets Not Available
                            </div>
                        `}
                    </div>
                </div>
                `;
            }).join('');
        }

        function displayPagination(currentPage, totalPages, total) {
            if (totalPages <= 1) {
                document.getElementById('pagination').style.display = 'none';
                return;
            }

            document.getElementById('pagination').style.display = 'flex';
            const pagination = document.getElementById('pagination');
            let buttons = '';

            if (currentPage > 1) {
                buttons += `<button onclick="fetchDatabaseEvents(${currentPage - 1})" class="px-4 py-2 bg-white rounded-lg hover:bg-slate-50 border border-slate-200 text-slate-700">Previous</button>`;
            }

            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                const activeClass = i === currentPage ? 'bg-slate-700 text-white' : 'bg-white hover:bg-slate-50 text-slate-700';
                buttons += `<button onclick="fetchDatabaseEvents(${i})" class="px-4 py-2 ${activeClass} rounded-lg border border-slate-200">${i}</button>`;
            }

            if (currentPage < totalPages) {
                buttons += `<button onclick="fetchDatabaseEvents(${currentPage + 1})" class="px-4 py-2 bg-white rounded-lg hover:bg-slate-50 border border-slate-200 text-slate-700">Next</button>`;
            }

            pagination.innerHTML = buttons;
        }

        async function trackAndRedirect(eventId, affiliateUrl) {
            try {
                if (eventId && eventId !== 'undefined') {
                    await fetch(`${API_BASE_URL}/events/${eventId}/click`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ platform: 'ticketmaster' })
                    });
                }
            } catch (error) {
                console.error('Error tracking click:', error);
            }
            
            window.open(affiliateUrl, '_blank');
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        function showLoading() {
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('eventsGrid').style.display = 'none';
            document.getElementById('noResults').style.display = 'none';
            document.getElementById('pagination').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loadingSpinner').style.display = 'none';
        }

        function showError(message) {
            hideLoading();
            alert(message);
        }
    </script>
</body>
</html>