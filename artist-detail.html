<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artist Tour Details</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #map { height: 500px; border-radius: 0.5rem; }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-100 min-h-screen">
    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-3xl font-bold text-gray-900" id="artistName">Artist Tour</h1>
                <a href="event-tracker.html" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                    Back to Events
                </a>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Artist Header -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex items-center gap-6">
                <img id="artistImage" src="" alt="" class="w-32 h-32 rounded-lg object-cover shadow-lg" style="display:none;">
                <div>
                    <h2 class="text-3xl font-bold text-gray-900" id="artistNameHeader"></h2>
                    <p class="text-gray-600" id="artistGenre"></p>
                </div>
            </div>
        </div>

        <!-- Date Filter -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-lg font-bold mb-4">Filter by Date</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Start Date</label>
                    <input type="date" id="startDate" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">End Date</label>
                    <input type="date" id="endDate" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div class="flex items-end gap-2">
                    <button onclick="applyDateFilter()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Apply</button>
                    <button onclick="clearDateFilter()" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Clear</button>
                </div>
            </div>
            <p class="text-sm text-gray-600 mt-2" id="dateFilterInfo">Showing all tour dates</p>
        </div>

        <!-- Tour Map -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Tour Route</h2>
                <div class="text-sm text-gray-600" id="eventCount"></div>
            </div>
            <div id="map"></div>
        </div>

        <!-- Events List (TEXT FORMAT) -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-bold mb-4">All Tour Dates</h2>
            <div id="eventsList" class="space-y-3">
                <!-- Events appear here -->
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:5000/api/v1';
        const urlParams = new URLSearchParams(window.location.search);
        const artistId = urlParams.get('id');
        const artistName = urlParams.get('name');
        
        let map = null;
        let allEvents = [];
        let filteredEvents = [];
        let markers = [];
        let polylines = [];

        document.addEventListener('DOMContentLoaded', () => {
            if (!artistId) {
                alert('No artist selected');
                window.location.href = 'event-tracker.html';
                return;
            }
            
            document.getElementById('artistName').textContent = artistName || 'Artist Tour';
            initMap();
            loadArtistData();
        });

        function initMap() {
            map = L.map('map').setView([39.8283, -98.5795], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap',
                maxZoom: 18
            }).addTo(map);
        }

        async function loadArtistData() {
            try {
                const response = await fetch(`${API_BASE_URL}/events/tour-map/${artistId}`);
                const data = await response.json();
                
                if (data.success) {
                    allEvents = data.events;
                    filteredEvents = [...allEvents];
                    
                    document.getElementById('artistNameHeader').textContent = data.artist.name;
                    document.getElementById('artistGenre').textContent = data.artist.genre?.join(', ') || '';
                    
                    if (allEvents[0]?.image) {
                        const img = document.getElementById('artistImage');
                        img.src = allEvents[0].image;
                        img.style.display = 'block';
                    }
                    
                    displayEventsList();
                    displayMap();
                } else {
                    alert('No tour data found');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error loading tour data');
            }
        }

        function displayEventsList() {
            const container = document.getElementById('eventsList');
            document.getElementById('eventCount').textContent = `${filteredEvents.length} shows`;
            
            container.innerHTML = filteredEvents.map((event, index) => {
                const eventDate = new Date(event.date);
                return `
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                        <div class="flex items-center gap-4">
                            <div class="flex-shrink-0 w-12 h-12 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold text-lg">
                                ${index + 1}
                            </div>
                            <div class="flex-1 grid grid-cols-1 md:grid-cols-5 gap-4 items-center">
                                <div>
                                    <p class="text-xs text-gray-500 uppercase">Date</p>
                                    <p class="font-semibold">${eventDate.toLocaleDateString('en-US', {
                                        month: 'short',
                                        day: 'numeric',
                                        year: 'numeric'
                                    })}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500 uppercase">Time</p>
                                    <p class="font-semibold">${eventDate.toLocaleTimeString('en-US', {
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    })}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500 uppercase">City</p>
                                    <p class="font-semibold">${event.venue.city}, ${event.venue.state || event.venue.country}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500 uppercase">Venue</p>
                                    <p class="font-semibold">${event.venue.name}</p>
                                </div>
                                <div class="text-right">
                                    ${event.affiliateUrl ? `
                                        <a href="${event.affiliateUrl}" target="_blank"
                                           class="inline-block px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold">
                                            Get Tickets
                                        </a>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function displayMap() {
            clearMapLayers();
            
            if (filteredEvents.length === 0) return;
            
            const cityGroups = {};
            filteredEvents.forEach(event => {
                const key = `${event.venue.city}-${event.venue.coordinates.join(',')}`;
                if (!cityGroups[key]) {
                    cityGroups[key] = {
                        city: event.venue.city,
                        state: event.venue.state,
                        coords: event.venue.coordinates,
                        events: []
                    };
                }
                cityGroups[key].events.push(event);
            });

            const bounds = [];
            
            Object.values(cityGroups).forEach(group => {
                const [lng, lat] = group.coords;
                bounds.push([lat, lng]);
                
                const showCount = group.events.length;
                const markerIcon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background: #4F46E5; color: white; border: 3px solid white; border-radius: 50%; 
                           width: ${30 + showCount * 5}px; height: ${30 + showCount * 5}px; 
                           display: flex; align-items: center; justify-content: center; 
                           font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                           ${showCount}
                           </div>`,
                    iconSize: [30 + showCount * 5, 30 + showCount * 5]
                });
                
                const marker = L.marker([lat, lng], { icon: markerIcon }).addTo(map);
                
                const popupContent = `
                    <div class="p-2">
                        <h3 class="font-bold">${group.city}, ${group.state}</h3>
                        <p class="text-sm">${showCount} show${showCount > 1 ? 's' : ''}</p>
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                markers.push(marker);
            });

            if (filteredEvents.length > 1) {
                for (let i = 0; i < filteredEvents.length - 1; i++) {
                    const [lng1, lat1] = filteredEvents[i].venue.coordinates;
                    const [lng2, lat2] = filteredEvents[i + 1].venue.coordinates;
                    
                    const line = L.polyline([[lat1, lng1], [lat2, lng2]], {
                        color: '#4F46E5',
                        weight: 3,
                        opacity: 0.6
                    }).addTo(map);
                    polylines.push(line);
                    
                    const midLat = (lat1 + lat2) / 2;
                    const midLng = (lng1 + lng2) / 2;
                    const arrow = L.marker([midLat, midLng], {
                        icon: L.divIcon({
                            className: 'arrow-icon',
                            html: '→',
                            iconSize: [20, 20]
                        })
                    }).addTo(map);
                    markers.push(arrow);
                }
            }

            if (bounds.length > 0) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        function clearMapLayers() {
            markers.forEach(m => map.removeLayer(m));
            polylines.forEach(p => map.removeLayer(p));
            markers = [];
            polylines = [];
        }

        function applyDateFilter() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            
            if (!start && !end) {
                filteredEvents = [...allEvents];
                document.getElementById('dateFilterInfo').textContent = 'Showing all tour dates';
            } else {
                filteredEvents = allEvents.filter(event => {
                    const eventDate = new Date(event.date);
                    const startDate = start ? new Date(start) : null;
                    const endDate = end ? new Date(end) : null;
                    
                    if (startDate && eventDate < startDate) return false;
                    if (endDate && eventDate > endDate) return false;
                    return true;
                });
                
                const startStr = start ? new Date(start).toLocaleDateString() : 'beginning';
                const endStr = end ? new Date(end).toLocaleDateString() : 'end';
                document.getElementById('dateFilterInfo').textContent = `${startStr} to ${endStr}`;
            }
            
            displayEventsList();
            displayMap();
        }

        function clearDateFilter() {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            filteredEvents = [...allEvents];
            document.getElementById('dateFilterInfo').textContent = 'Showing all tour dates';
            displayEventsList();
            displayMap();
        }
    </script>
</body>
</html>